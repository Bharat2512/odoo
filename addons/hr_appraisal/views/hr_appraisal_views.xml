<?xml version="1.0" ?>
<odoo>

    <menuitem name="Appraisal" id="menu_hr_appraisal_root" sequence="25"/>
    <menuitem name="Periodic Appraisal" id="menu_hr_appraisal_configuration" sequence="4"/>

    <record model="ir.ui.view" id="view_hr_appraisal_form">
        <field name="name">hr.appraisal.form</field>
        <field name="model">hr.appraisal</field>
        <field name="arch" type="xml">
            <form string="Appraisal">
            <header>
                <button name="button_send_appraisal" string="Start Appraisal and Send Forms" states="new" type="object" class="oe_highlight"  groups="base.group_hr_user"/>
                <button name="button_done_appraisal" string="Done" states="pending" type="object"  groups="base.group_hr_user"/>
                <field name="state" widget="statusbar" options="{'fold_field': 'fold'}"/>
            </header>
            <sheet>
                <div class="oe_right oe_button_box">
                    <button class="oe_inline oe_stat_button" name="action_get_users_input" type="object" icon="fa-reply" context="{'answers':True}">
                        <div><strong><field name="count_completed_survey"/></strong><br/>Answers</div>
                    </button>
                </div>
                <label for="employee_id" class="oe_edit_only"/>
                <h1>
                    <field name="employee_id" class="oe_inline"  attrs="{'readonly':[('state', '!=', 'new')]}"/>
                </h1>
                <group>
                    <group>
                        <field name="department_id" attrs="{'readonly':[('state', '!=', 'new')]}" groups="hr.group_multi_departments"/>
                        <field name="date_close" attrs="{'readonly':[('state','in', ('pending','done'))]}"/>
                    </group>
                    <group>
                        <field name="date_final_interview"/>
                        <field name="mail_template_id" attrs="{'readonly':[('state', '!=', 'new')]}" groups="base.group_no_one"/>
                        <field name="meeting_id" invisible="True"/>
                        <field name="company_id" invisible="True"/>
                    </group>
                </group>
                <notebook>
                    <page string="Final Evaluation" attrs="{'invisible':[('state','=','new')]}">
                        <field name="action_plan"/>
                    </page>
                    <page string="Plan">
                        <group col="4">
                            <label for="manager_appraisal" string="Send Appraisal Form To"/>
                            <group col="3">
                                <div class="address_format">
                                    <field name="manager_appraisal" attrs="{'readonly':[('state', '!=', 'new')]}"/>
                                    <label string="Managers"/>
                                </div>
                                <field name="manager_ids" nolabel="1" placeholder="Select Appraisal Reviewer..." widget="many2many_tags" attrs="{'invisible':[('manager_appraisal','=',False)], 'readonly':[('state', '!=', 'new')]}"/>
                                <field name="manager_survey_id" nolabel="1" placeholder="Appraisal Form..." attrs="{'invisible':[('manager_appraisal','=',False)], 'readonly':[('state', '!=', 'new')]}"/>
                                <div class="address_format">
                                    <field name="employee_appraisal" attrs="{'readonly':[('state', '!=', 'new')]}"/>
                                    <label string="Employee"/>
                                </div>
                                <field name="employee_survey_id" nolabel="1" placeholder="Appraisal Form..." attrs="{'invisible':[('employee_appraisal','=',False)], 'readonly':[('state', '!=', 'new')]}"/><br></br>
                                <div class="address_format">
                                    <field name="collaborators_appraisal" attrs="{'readonly':[('state', '!=', 'new')]}"/>
                                    <label string="Collaborators"/>
                                </div>
                                <field name="collaborators_ids" nolabel="1" placeholder="Select Appraisal Reviewer..." widget="many2many_tags" attrs="{'invisible':[('collaborators_appraisal','=',False)], 'readonly':[('state', '!=', 'new')]}"/>
                                <field name="collaborators_survey_id" nolabel="1" placeholder="Appraisal Form..." attrs="{'invisible':[('collaborators_appraisal','=',False)], 'readonly':[('state', '!=', 'new')]}"/>
                                <div class="address_format">
                                    <field name="colleagues_appraisal" attrs="{'readonly':[('state', '!=', 'new')]}"/>
                                    <label string="Colleagues"/>
                                </div>
                                <field name="colleagues_ids" nolabel="1" placeholder="Select Appraisal Reviewer..." widget="many2many_tags" attrs="{'invisible':[('colleagues_appraisal','=',False)], 'readonly':[('state', '!=', 'new')]}"/>
                                <field name="colleagues_survey_id" nolabel="1" placeholder="Appraisal Form..." attrs="{'invisible':[('colleagues_appraisal','=',False)], 'readonly':[('state', '!=', 'new')]}"/>
                            </group>
                        </group>
                    </page>
                </notebook>
          </sheet>
          <div class="oe_chatter">
              <field name="message_follower_ids" widget="mail_followers" groups="base.group_user"/>
              <field name="message_ids" widget="mail_thread"/>
          </div>
          </form>
        </field>
    </record>

    <record model="ir.ui.view" id="view_hr_appraisal_tree">
        <field name="name">hr.appraisal.tree</field>
        <field name="model">hr.appraisal</field>
        <field name="arch" type="xml">
            <tree string="Appraisal">
                <field name="employee_id" string="Name"/>
                <field name="date_close"/>
                <field name="date_final_interview"/>
                <field name="state"/>
                <field name="count_survey_sent" readonly="0"/>
                <field name="count_completed_survey" readonly="0"/>
            </tree>
        </field>
    </record>

   <record id="hr_appraisal_search" model="ir.ui.view">
        <field name="name">hr.appraisal.search</field>
        <field name="model">hr.appraisal</field>
        <field name="arch" type="xml">
            <search string="Search Appraisal">
                <field name="employee_id"/>
                <group expand='0' string='Group by...'>
                    <filter string='Employee' icon="terp-personal" domain="[]" context="{'group_by' : 'employee_id'}"/>
               </group>
           </search>
        </field>
    </record>

    <record id="hr_appraisal_kanban" model="ir.ui.view">
        <field name="name">hr.appraisal.kanban</field>
        <field name="model">hr.appraisal</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" quick_create="0">
                <field name="employee_id"/>
                <field name="department_id"/>
                <field name="date_final_interview"/>
                <field name="color"/>
                <field name="manager_ids"/>
                <field name="date_close"/>
                <field name="state"/>
                <field name="survey_sent_ids"/>
                <field name="count_survey_sent"/>
                <field name="count_completed_survey"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_color_#{kanban_getcolor(record.color.raw_value)} oe_kanban_card oe_kanban_global_click">
                        <div class="oe_dropdown_toggle oe_dropdown_kanban" groups="base.group_user">
                            <i class="fa fa-bars fa-lg"/>
                            <ul class="oe_dropdown_menu">
                                <t t-if="widget.view.is_action_enabled('edit')"><li><a type="edit">Edit...</a></li></t>
                                <t t-if="widget.view.is_action_enabled('delete')"><li><a type="delete">Delete</a></li></t>
                                <li><ul class="oe_kanban_colorpicker" data-field="color"/></li>
                            </ul>
                        </div>
                        <div class="oe_kanban_content">
                            <div><b><field name="employee_id"/></b></div>
                            <div groups="hr.group_multi_departments">
                                <field name="department_id"/>
                            </div>
                            <t t-if="record.date_close.raw_value and record.date_close.raw_value &lt; (new Date())" t-set="red">oe_kanban_text_red</t>
                                Deadline :<span t-attf-class="#{red}"><i><field name="date_close"/></i></span>
                            <br/>
                            <div>
                                <li>
                                    <t t-if="! record.date_final_interview.raw_value and record.state.raw_value != 'new'">
                                    <strong><a name="action_calendar_event" type="object">Schedule The Final Interview</a></strong></t>
                                    <t t-if="record.date_final_interview.raw_value and record.state.raw_value != 'new' and record.date_final_interview.raw_value &lt; (new Date())" t-set="deadline">oe_kanban_text_red</t>
                                    <t t-if="record.date_final_interview.raw_value and record.state.raw_value != 'new'"><strong><span>Final Interview: </span></strong>
                                    <span t-attf-class="#{deadline}"><i><field name="date_final_interview"/></i></span></t>
                                </li>
                            </div>
                            <div>
                                <a name="action_get_users_input" type="object">(<field name="count_survey_sent">) Sent Appraisal</field></a>
                                <a name="action_get_users_input" type="object" context="{'answers':True}"> (<field name="count_completed_survey">) Answers </field></a>
                            </div>
                            <div class="oe_kanban_bottom_right_appraisal">
                                <img t-att-src="kanban_image('hr.employee', 'image_small', record.employee_id.raw_value)" t-att-title="record.employee_id.value" width="24" height="24" class="oe_kanban_avatar pull-right"/>
                                <t t-foreach="record.manager_ids.raw_value.slice(0,12)" t-as="manager">
                                    <img t-att-src="kanban_image('hr.employee', 'image_small', manager)" t-att-data-manager_ids="manager" width="24" height="24" class="oe_kanban_avatar pull-right"/>
                                </t>
                            </div>
                            <div class="oe_clear"></div>
                        </div>
                      </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record model="ir.actions.act_window" id="open_view_hr_appraisal_tree">
        <field name="name">Appraisal</field>
        <field name="res_model">hr.appraisal</field>
        <field name="view_type">form</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="context">{"search_default_next_month":1}</field>
        <field name="help" type="html">
          <p class="oe_view_nocontent_create">
            Click to create a new appraisal.
          </p><p>
            You will be able to choose which forms will be sent (Employee,Managers,Collaborators or Colleagues),
            to whom and the evaluation deadline. Once you have defined it,
            change the stage to send it and view the results.
          </p>
        </field>
    </record>

    <menuitem name="Appraisal" parent="menu_hr_appraisal_root" id="menu_open_view_hr_appraisal_tree"
        action="open_view_hr_appraisal_tree" groups="base.group_user"/>

    <record model="ir.actions.act_window" id="open_view_hr_appraisal_tree2">
        <field name="name">Appraisal</field>
        <field name="res_model">hr.appraisal</field>
        <field name="view_type">form</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="context">{"search_default_employee_id": [active_id]}</field>
    </record>

    <record id="hr_employee_view_form" model="ir.ui.view">
        <field name="name">hr.employee.view.form.inherit.appraisal</field>
        <field name="model">hr.employee</field>
        <field name="inherit_id" ref="hr.view_employee_form"/>
        <field name="arch" type="xml">
        <xpath expr="//div[@name='button_box']" position="inside">
            <button name="%(open_view_hr_appraisal_tree2)d"
                class="oe_inline oe_stat_button"
                icon="fa-sitemap"
                type="action">
                <div><strong><field name="appraisal_count"/></strong><br/>Appraisal</div>
            </button>
        </xpath>
        <xpath expr="//page[@name='hr_settings']" position="after">
            <page string="Appraisal">
                <group col="4">
                    <label for="appraisal_by_manager" string="Send Appraisal Form To"/>
                    <group col="3">
                        <div class="address_format">
                            <field name="appraisal_by_manager"/>
                            <label string="Managers"/>
                        </div>
                        <field name="appraisal_manager_ids" nolabel="1" placeholder="Select Appraisal Reviewer..." widget="many2many_tags" attrs="{'invisible':[('appraisal_by_manager','=',False)]}" readonly="0"/>
                        <field name="appraisal_manager_survey_id" nolabel="1" placeholder="Appraisal Form..." attrs="{'invisible':[('appraisal_by_manager','=',False)]}"/>
                        <div class="address_format">
                            <field name="appraisal_self"/>
                            <label string="Employee"/>
                        </div>
                        <field name="appraisal_employee" nolabel="1" attrs="{'invisible':[('appraisal_self','=',False)]}"/>
                        <field name="appraisal_self_survey_id" nolabel="1" placeholder="Appraisal Form..." attrs="{'invisible':[('appraisal_self','=',False)]}"/>
                        <div class="address_format">
                            <field name="appraisal_by_collaborators"/>
                            <label string="Collaborators"/>
                        </div>
                        <field name="appraisal_by_collaborators_ids" nolabel="1" placeholder="Select Appraisal Reviewer..." widget="many2many_tags" attrs="{'invisible':[('appraisal_by_collaborators','=',False)]}"/>
                        <field name="appraisal_by_collaborators_survey_id" nolabel="1" placeholder="Appraisal Form..." attrs="{'invisible':[('appraisal_by_collaborators','=',False)]}"/>
                        <div class="address_format">
                            <field name="appraisal_by_colleagues"/>
                            <label string="Colleagues"/>
                        </div>
                        <field name="appraisal_colleagues_ids" nolabel="1" placeholder="Select Appraisal Reviewer..." widget="many2many_tags" attrs="{'invisible':[('appraisal_by_colleagues','=',False)]}" readonly="0"/>
                        <field name="appraisal_colleagues_survey_id" placeholder="Appraisal Form..." nolabel="1" attrs="{'invisible':[('appraisal_by_colleagues','=',False)]}"/>
                    </group>
                </group>
                <group string="Periodicity" col="5">
                    <label for="periodic_appraisal"/>
                    <div class="address_format">
                        <field name="periodic_appraisal"/>
                    </div>
                    <field name="appraisal_repeat_number" attrs="{'invisible':[('periodic_appraisal','=',False)], 'required':[('periodic_appraisal','=',True)]}"/>
                    <field name="appraisal_repeat_delay" attrs="{'invisible':[('periodic_appraisal','=',False)], 'required':[('periodic_appraisal','=',True)]}" nolabel="1"/>
                    <field name="appraisal_date" attrs="{'invisible':[('periodic_appraisal','=',False)], 'required':[('periodic_appraisal','=',True)]}"/>
                </group>
            </page>
        </xpath>
        </field>
    </record>

    <record id="hr_appraisal_action_from_department" model="ir.actions.act_window">
            <field name="name">Appraisal to start</field>
            <field name="res_model">hr.appraisal</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="hr_appraisal_search"/>
            <field name="domain">[('employee_id.department_id', '=', active_id), ('state', '=', 'new')]</field>
    </record>
</odoo>
