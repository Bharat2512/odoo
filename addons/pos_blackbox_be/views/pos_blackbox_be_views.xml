<?xml version="1.0" encoding="UTF-8"?>
<openerp>
    <data>
        <record id="res_users_form_view" model="ir.ui.view">
            <field name="name">res.users.form.view</field>
            <field name="model">res.users</field>
            <field name="inherit_id" ref="point_of_sale.res_users_form_view" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='pos_security_pin']" position="after">
                    <field name="insz_or_bis_number" />
                </xpath>
            </field>
        </record>

        <record model="ir.ui.view" id="view_pos_config_blackbox_form">
            <field name="name">pos.config.form.view</field>
            <field name="model">pos.config</field>
            <field name="inherit_id" ref="point_of_sale.view_pos_config_form"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='iface_cashdrawer']" position="after">
                    <field name="iface_blackbox_be"/>
                </xpath>
            </field>
        </record>

        <record model="ir.ui.view" id="view_pos_order_tree">
            <field name="name">Orders</field>
            <field name="model">pos.order</field>
            <field name="inherit_id" ref="point_of_sale.view_pos_order_tree"/>
            <field name="arch" type="xml">
                <tree position="attributes">
                    <attribute name="create">false</attribute>
                </tree>
            </field>
        </record>

        <record model="ir.ui.view" id="view_pos_pos_form">
            <field name="name">pos.order</field>
            <field name="model">pos.order</field>
            <field name="inherit_id" ref="point_of_sale.view_pos_pos_form"/>
            <field name="arch" type="xml">
                <form position="attributes">
                    <attribute name="create">false</attribute>
                    <attribute name="edit">false</attribute>
                    <attribute name="delete">false</attribute>
                </form>

                <xpath expr="//button[@name='%(point_of_sale.action_pos_payment)d']" position="replace"/>
                <xpath expr="//button[@name='refund']" position="replace"/>
                <xpath expr="//button[@name='%(point_of_sale.action_report_pos_receipt)d']" position="replace"/>

                <xpath expr="//field[@name='tax_ids']" position="after">
                    <field name="vat_letter"/>
                </xpath>
                <xpath expr="//page[@name='extra']" position="inside">
                    <group string="Fiscal Data Module information">
                        <field name="blackbox_date" readonly="1"/>
                        <field name="blackbox_time" readonly="1"/>
                        <field name="blackbox_ticket_counters" readonly="1"/>
                        <field name="blackbox_unique_fdm_production_number" readonly="1"/>
                        <field name="blackbox_vsc_identification_number" readonly="1"/>
                        <field name="blackbox_signature" readonly="1"/>
                        <field name="blackbox_tax_category_a" readonly="1"/>
                        <field name="blackbox_tax_category_b" readonly="1"/>
                        <field name="blackbox_tax_category_c" readonly="1"/>
                        <field name="blackbox_tax_category_d" readonly="1"/>
                        <field name="plu_hash" readonly="1"/>
                        <field name="pos_version" readonly="1"/>
                        <field name="pos_production_id" readonly="1"/>
                    </group>
                </xpath>
            </field>
        </record>

        <record model="ir.actions.act_window" id="action_pos_order_pro_forma_form">
            <field name="name">Orders Pro Forma</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">pos.order_pro_forma</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="view_id" eval="False"/>
            <field name="domain">[]</field>
        </record>

        <menuitem parent="point_of_sale.menu_point_of_sale" id="menu_order_pro_forma" action="action_pos_order_pro_forma_form" sequence="1" groups="point_of_sale.group_pos_manager,point_of_sale.group_pos_user"/>

        <record model="ir.ui.view" id="view_pos_order_pro_forma_tree">
            <field name="name">Orders Pro Forma</field>
            <field name="model">pos.order_pro_forma</field>
            <field name="arch" type="xml">
                <tree string="POS Orders Pro Forma" default_order="date_order desc" create="false" edit="false" delete="false">
                    <field name="name"/>
                    <field name="partner_id"/>
                    <field name="date_order"/>
                    <field name="user_id"/>
                    <field name="amount_total" sum="Amount total" widget="monetary"/>
                    <field name="session_id" />
                </tree>
            </field>
        </record>

        <record model="ir.ui.view" id="view_pos_order_pro_forma_form">
            <field name="name">pos.order_pro_forma</field>
            <field name="model">pos.order_pro_forma</field>
            <field name="arch" type="xml">
                <form string="Point of Sale Orders Pro Forma" create="false" edit="false" delete="false">
                    <sheet>
                        <group col="4" colspan="4" name="order_fields">
                            <field name="name"/>
                            <field name="date_order"/>
                            <field name="session_id" />
                            <field name="partner_id" on_change="onchange_partner_id(partner_id, context)" domain="[('customer', '=', True)]" context="{'search_default_customer':1}"/>
                        </group>
                        <notebook colspan="4">
                            <page string="Products">
                                <field name="lines" colspan="4" nolabel="1">
                                    <tree string="Order lines" editable="bottom">
                                        <field name="product_id" on_change="onchange_product_id(parent.pricelist_id,product_id,qty,parent.partner_id)"/>
                                        <field name="qty" on_change="onchange_qty(parent.pricelist_id,product_id, discount, qty, price_unit, context)"/>
                                        <field name="price_unit" on_change="onchange_qty(parent.pricelist_id,product_id, discount, qty, price_unit, context)" widget="monetary"/>
                                        <field name="discount"  on_change="onchange_qty(parent.pricelist_id,product_id, discount, qty, price_unit, context)" widget="monetary"/>
                                        <field name="tax_ids" widget="many2many_tags"/>
                                        <field name="price_subtotal" widget="monetary"/>
                                        <field name="price_subtotal_incl" widget="monetary"/>
                                    </tree>
                                    <form string="Order lines">
                                        <group col="4">
                                            <field name="product_id" on_change="onchange_product_id(parent.pricelist_id,product_id,qty,parent.partner_id)"/>
                                            <field name="qty" on_change="onchange_qty(parent.pricelist_id,product_id, discount, qty, price_unit, context)"/>
                                            <field name="discount"  on_change="onchange_qty(parent.pricelist_id,product_id, discount, qty, price_unit, context)" widget="monetary"/>
                                            <field name="price_unit" on_change="onchange_qty(parent.pricelist_id,product_id, discount, qty, price_unit, context)" widget="monetary"/>
                                            <field name="price_subtotal" invisible="1" widget="monetary"/>
                                            <field name="price_subtotal_incl" invisible="1" widget="monetary"/>
                                            <field name="notice"/>
                                        </group>
                                    </form>
                                </field>
                                <group class="oe_subtotal_footer oe_right" colspan="2" name="order_total">
                                    <div class="oe_subtotal_footer_separator oe_inline">
                                        <label for="amount_total" />
                                    </div>
                                    <field name="amount_total" nolabel="1" class="oe_subtotal_footer_separator" widget="monetary"/>
                                </group>
                                <div class="oe_clear"/>
                            </page>
                            <page name="extra" string="Extra Info">
                                <group string="Fiscal Data Module information">
                                    <field name="blackbox_date"/>
                                    <field name="blackbox_time"/>
                                    <field name="blackbox_ticket_counters"/>
                                    <field name="blackbox_unique_fdm_production_number"/>
                                    <field name="blackbox_vsc_identification_number"/>
                                    <field name="blackbox_signature"/>
                                    <field name="blackbox_tax_category_a"/>
                                    <field name="blackbox_tax_category_b"/>
                                    <field name="blackbox_tax_category_c"/>
                                    <field name="blackbox_tax_category_d"/>
                                    <field name="plu_hash"/>
                                    <field name="pos_version"/>
                                    <field name="pos_production_id"/>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- get rid of cashbox stuff, because it's currently broken -->
        <record model="ir.ui.view" id="view_pos_session_form">
            <field name="name">pos.session.form.view</field>
            <field name="model">pos.session</field>
            <field name="inherit_id" ref="point_of_sale.view_pos_session_form"/>
            <field name="arch" type="xml">
                <div class="oe_button_box" position="replace"/>
            </field>
        </record>

        <!-- include vat number in report -->
        <template id="include_vat_number" inherit_id="report.external_layout_header">
            <xpath expr="//div[@name='company_address']" position="after">
                <div class="col-xs-9" name="company_address">
                    VAT: <t t-esc="company.vat"/>
                </div>
            </xpath>
        </template>

        <report id="action_report_pos_session_summary"
                string="Z-report"
                model="pos.session"
                report_type="qweb-pdf"
                name="pos_blackbox_be.z_report_template"
                file="pos_blackbox_be.z_report_template"
                attachment_use="False"/>
        <!-- attachment="(object.name + '/z-report.pdf')"/> -->

        <template id="z_report_template">
            <t t-call="report.html_container">
                <t t-foreach="docs" t-as="o">
                    <t t-call="report.external_layout">
                        <div class="page">
                            <h2>Z FINANCIAL</h2>
                            <div class="row">
                                <div class="col-xs-12">
                                    <strong>POS Session:</strong>
                                    <span t-field="o.name"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <strong>Sequence number:</strong>
                                    <span t-esc="o.config_id.report_sequence_id._next()"/>
                                </div>
                            </div>
                            <div class="row mt32 mb32">
                                <div class="col-xs-3">
                                    <strong>Responsible</strong>:<br/>
                                    <span t-field="o.user_id"/>
                                </div>
                                <div class="col-xs-3">
                                    <strong>Point of Sale</strong>:<br/>
                                    <span t-field="o.config_id"/>
                                </div>
                                <div class="col-xs-3">
                                    <strong>From</strong>:<br/>
                                    <span t-field="o.start_at"/>
                                </div>
                                <div class="col-xs-3">
                                    <strong>To</strong>:<br/>
                                    <!-- <span t-field="o.stop_at"/> --> <!-- for z-reports -->
                                    <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%m/%d/%Y %H:%M:%S')"/> <!-- for x-reports -->
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <strong>Total revenue</strong>:
                                    <span t-field="o.total_sold"/>
                                </div>
                            </div>
                            <strong>Total base of measure per tax</strong>:
                            <div class="row">
                                <div class="col-xs-3">
                                    <strong>A</strong>:
                                    <span t-field="o.total_base_of_measure_tax_a"/>
                                </div>
                                <div class="col-xs-3">
                                    <strong>B</strong>:
                                    <span t-field="o.total_base_of_measure_tax_b"/>
                                </div>
                                <div class="col-xs-3">
                                    <strong>C</strong>:
                                    <span t-field="o.total_base_of_measure_tax_c"/>
                                </div>
                                <div class="col-xs-3">
                                    <strong>D</strong>:
                                    <span t-field="o.total_base_of_measure_tax_d"/>
                                </div>
                            </div>
                            <strong>Total tax</strong>:
                            <div class="row">
                                <div class="col-xs-3">
                                    <strong>A</strong>:
                                    <span t-field="o.total_tax_a"/>
                                </div>
                                <div class="col-xs-3">
                                    <strong>B</strong>:
                                    <span t-field="o.total_tax_b"/>
                                </div>
                                <div class="col-xs-3">
                                    <strong>C</strong>:
                                    <span t-field="o.total_tax_c"/>
                                </div>
                                <div class="col-xs-3">
                                    <strong>D</strong>:
                                    <span t-field="o.total_tax_d"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <strong>Amount in cash register at end of period</strong>:
                                    <span t-field="o.cash_register_balance_end_real"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <strong>Amount of VAT tickets</strong>:
                                    <span t-field="o.amount_of_vat_tickets"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <strong>Amount of Pro Forma VAT tickets</strong>:
                                    <span t-field="o.amount_of_pro_forma_tickets"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <strong>Revenue of Pro Forma VAT tickets (including VAT)</strong>:
                                    <span t-field="o.total_pro_forma"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <strong>Amount of discounts</strong>:
                                    <span t-field="o.amount_of_discounts"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <strong>Total discounts</strong>:
                                    <span t-field="o.total_discount"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </t>
            </t>
        </template>

        <!-- <menuitem name="Z-reports" action="z_report" id="menu_report_z_report" parent="point_of_sale.menu_point_rep" sequence="100"/> -->
    </data>
</openerp>
